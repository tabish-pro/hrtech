
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login - Resume Analyzer</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
    </head>
    <body>
        <!-- License Validation Modal -->
        <div id="licenseModal" class="license-modal" style="display: none;">
            <div class="license-modal-content">
                <div class="license-header">
                    <i class="fas fa-key"></i>
                    <h2>License Required</h2>
                </div>

                <div id="licenseWarning" class="license-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Your license will expire in <span id="daysRemaining"></span> days.</p>
                    <p>Please enter your license key to continue using the application.</p>
                </div>

                <div id="licenseExpired" class="license-expired" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Your license has expired. Please enter a valid license key to continue.</p>
                </div>

                <form id="licenseForm">
                    <div class="input-group">
                        <label for="licenseKey">
                            <i class="fas fa-key"></i>
                            License Key
                        </label>
                        <input
                            type="text"
                            id="licenseKey"
                            name="licenseKey"
                            placeholder="Enter your license key"
                            required
                        />
                    </div>

                    <button type="submit" class="license-btn">
                        <i class="fas fa-check"></i>
                        Activate License
                    </button>

                    <div id="licenseError" class="error-message" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Invalid license key. Please try again.
                    </div>
                </form>

                <button id="skipLicenseBtn" class="skip-license-btn" style="display: none;">
                    <i class="fas fa-arrow-right"></i>
                    Continue Anyway
                </button>
            </div>
        </div>

        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1><i class="fas fa-user-tie"></i> Lamprell Resume Analyzer</h1>
                    <p>AI-powered recruitment tool</p>
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="input-group">
                        <label for="username">
                            <i class="fas fa-user"></i>
                            Username
                        </label>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            placeholder="Enter your username"
                            required
                        />
                    </div>
                    
                    <div class="input-group">
                        <label for="password">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Enter your password"
                            required
                        />
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    
                    <div id="errorMessage" class="error-message" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Invalid username or password. Please try again.
                    </div>
                </form>
                
                <div class="login-footer">
                    <small>
                        <i class="fas fa-shield-alt"></i>
                        Secure HR Authentication System
                    </small>
                </div>
            </div>
        </div>

        <script>
            // Store CSRF token in memory (not localStorage/sessionStorage for security)
            let csrfToken = null;

            // Fetch CSRF token on page load
            async function fetchCsrfToken() {
                try {
                    const response = await fetch('/api/csrf-token', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    csrfToken = data.csrfToken;
                } catch (error) {
                    console.error('Failed to fetch CSRF token:', error);
                }
            }

            // Fetch CSRF token when page loads
            fetchCsrfToken();

            // Check license status on page load
            async function checkLicenseStatus() {
                try {
                    const response = await fetch('/api/license/status');
                    const data = await response.json();

                    if (data.requiresLicense) {
                        // License expired - show modal, hide login
                        document.getElementById('licenseModal').style.display = 'flex';
                        document.querySelector('.login-container').style.display = 'none';
                        document.getElementById('licenseExpired').style.display = 'block';
                        return false;
                    } else if (data.showWarning) {
                        // Show warning but allow login
                        document.getElementById('licenseModal').style.display = 'flex';
                        document.querySelector('.login-container').style.display = 'none';
                        document.getElementById('licenseWarning').style.display = 'block';
                        document.getElementById('daysRemaining').textContent = data.daysUntilExpiry;
                        document.getElementById('skipLicenseBtn').style.display = 'block';
                        return false;
                    }

                    return true; // License is valid or not yet required
                } catch (error) {
                    console.error('Failed to check license:', error);
                    return true; // Allow login on error
                }
            }

            // Handle license form submission
            document.getElementById('licenseForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const licenseKey = document.getElementById('licenseKey').value;
                const errorMessage = document.getElementById('licenseError');
                const submitBtn = this.querySelector('button[type="submit"]');

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
                submitBtn.disabled = true;
                errorMessage.style.display = 'none';

                try {
                    const response = await fetch('/api/license/validate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        credentials: 'include',
                        body: JSON.stringify({ licenseKey })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // License activated - hide modal, show login
                        document.getElementById('licenseModal').style.display = 'none';
                        document.querySelector('.login-container').style.display = 'flex';

                        // Show success message
                        alert('License activated successfully!');
                    } else {
                        throw new Error(result.error || 'Invalid license key');
                    }
                } catch (error) {
                    console.error('License validation error:', error);
                    errorMessage.textContent = error.message;
                    errorMessage.style.display = 'block';

                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Activate License';
                    submitBtn.disabled = false;
                }
            });

            // Handle skip button (only shown during warning period)
            document.getElementById('skipLicenseBtn').addEventListener('click', function() {
                document.getElementById('licenseModal').style.display = 'none';
                document.querySelector('.login-container').style.display = 'flex';
            });

            // Check license when page loads
            checkLicenseStatus();

            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorMessage = document.getElementById('errorMessage');
                const submitBtn = this.querySelector('button[type="submit"]');

                // Show loading state
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
                submitBtn.disabled = true;

                // Hide any previous error
                errorMessage.style.display = 'none';

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include', // Important: send/receive cookies
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // JWT token is now in HTTP-only cookie (secure)
                        // Store only non-sensitive user info in sessionStorage for UI purposes
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('username', result.user.username);
                        sessionStorage.setItem('isAdmin', result.user.isAdmin);
                        sessionStorage.setItem('userId', result.user.id);

                        // Redirect to main page
                        window.location.href = 'index.html';
                    } else {
                        throw new Error(result.error || 'Login failed');
                    }
                } catch (error) {
                    console.error('Login error:', error);

                    // Show error with better messaging
                    let errorText = error.message || 'Invalid username or password. Please try again.';

                    // Handle rate limiting
                    if (error.message && error.message.includes('Too many')) {
                        errorText = 'Too many login attempts. Please try again in 15 minutes.';
                    }

                    errorMessage.textContent = errorText;
                    errorMessage.style.display = 'block';

                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;

                    // Clear password field
                    document.getElementById('password').value = '';

                    // Shake animation
                    errorMessage.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        errorMessage.style.animation = '';
                    }, 500);
                }
            });

            // Check if already logged in (basic UI check - real auth is in cookie)
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                window.location.href = 'index.html';
            }
        </script>
    </body>
</html>
